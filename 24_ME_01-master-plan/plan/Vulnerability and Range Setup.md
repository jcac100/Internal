Before conducting the emulation plan, there are a couple configurations we need to validate are configured. Click on each item to navigate to the relevant section.

>[!info]- Kali Credentials
>user: kali
>password: MALware123!@#

# Network

- [ ] [[Vulnerability and Range Setup#Setup Static IPs for Kali Teamserver|Setup Teamserver IPs]] 
- [ ] [[Vulnerability and Range Setup#Setup DNS|Setup DNS]]
- [ ] [[Vulnerability and Range Setup#Setup CS client IPs|Setup CS client IPs]]
# Vulnerabilities
- [ ] [[Vulnerability and Range Setup#Connecting XXX-VPN-USER to domain VPN.|Connect Target Laptop to VPN]] 
- [ ] [[Vulnerability and Range Setup#Enable Unconstrained Delegation on MDA/PAO-SHRPT|Setup Unconstrained Delegation]]
- [ ] [[Vulnerability and Range Setup#Lateral movement via WMIC |Lateral Movement via WMIC]]
- [ ] [[Vulnerability and Range Setup#Setting up HiveNightmare |Setting up HiveNightmare]]


# Weaponization
- [ ] [[Vulnerability and Range Setup#Download Tools|Download Tools]]
- [ ] [[Vulnerability and Range Setup#Start CS Teamserver|Start Teamserver]]
- [ ] [[Vulnerability and Range Setup#Setup CS Client|Connect CS Client]]
- [ ] [[Vulnerability and Range Setup#Start Listeners|Setup Listener]]
- [ ] [[Vulnerability and Range Setup#Create and Stage Payloads|Stage Payloads]]

--------

<h1><center> Setup Network</center></h1>


## Setup Static IPs for Kali Teamserver

- Sign in to red-ops-kali-2 .

>[!warning]  Turn off NetworkManager!
>The current template of kali has two network services running. We will be using networking.service instead of NetworkManager.service. Make sure to stop and disable NetworkManager.service
>`sudo systemctl stop NetworkManager.service`
>`sudo systemctl disable NetworkManager.service`


- Using sudo, open `/etc/network/interfaces`
 
<center><ins>red-ops-kali-2</ins></center>

```
sudo nvim /etc/network/interfaces
```

Copy and paste the following at the end and save.

```/etc/network/interfaces

auto eth1
iface eth1 inet static
address 30.0.0.11/24
gateway 30.0.0.1

# www.google.com.ve
iface eth1 inet static
address 188.64.30.214/24

# video.memezilla.com.cn
iface eth1 inet static
address 152.42.85.67/24

# www.google.com.co
iface eth1 inet static
address 63.72.155.49/24
```

Restart the networking service, then make sure the IPs are populated.

```bash
sudo systemctl restart networking.service
ip -br a
```

>[!warning]- Troubleshooting
>If you mess up the configuration file, you can flush the IPs with 
>`sudo ip a flush dev eth1`
>This will remove all ips from the interface so that you can redo all of the above steps.

Test the connection to the router.

```bash
ping -c 3 30.0.0.1
```

>[!warning]- Troubleshooting
>If you cannot ping the router, double check that you only have one default route and check that the router has the correct ip address on it's interface with `show interfaces`. The credentials for the router are `vyatta:simnet` [[attachments/red-edge-router-interfaces.gif| Demonstration gif]]. The interfaces should look like the below:
>![[attachments/Vulnerability and Range Setup_image_1_20231011013008.png]]
>
>You can also check the route to your IPs from here:
>![[attachments/Vulnerability and Range Setup_image_2_20231011013008.png]]

[[Vulnerability and Range Setup#Network|Back to Top]]
## Setup DNS

#### Kali DNS
The kali DNS configuration file is `/etc/resolv.conf`. The following command will add 1.1.1.1 as your dns resolver.

```
sudo sed -i 's/8.*/1.1.1.1/' /etc/resolv.conf
```

Once you have your resolv.conf setup and your IPs, doublecheck that both of your Domains are properly configured.

```bash
nslookup video.memezilla.com.cn
nslookup www.google.com.ve
nslookup www.google.com.co
```

Alternatively you can ping. 
![[attachments/Vulnerability and Range Setup_image_3_20231011013008.png]]

>[!warning] Range Issues
>Recently, 1.1.1.1 has not always been working. I have seen TEAMS messages saying 8.8.8.8 works, but I don't know for sure if it uses the same powerdns server. Neither were working on the test range at the time of this writeup.



#### Domain DNS
Make sure that a domain joined computer can reach you via domain name. I recommend doing this from both the VPN laptop and the DC, since you will be logging into them anyway.

>[!Warning]- Troubleshooting 
>If a domain-joined host cannot find anything, then do the following:
>1.) Check internal DC DNS forwarder. It should point to DMZ DNS [[attachments/Internal-DNS.gif|Demonstration gif]] 
>2.) Check DMZ DNS forwarder. It should point to greyspace DNS.
>3.) If you can, sign in to the DNS server at https://10.10.1.101:30000/login. The credentials are `admin:admin`.
>4.) If you can't, the DNS server is likely down, contact SIMS.

[[Vulnerability and Range Setup#Network|Back to Top]]
## Setup CS client IPs

The red-edge-router does not have DHCP set up. So every other kali box that you plan to use for this attack must set a static ip.

>[!warning]-  Turn off NetworkManager!
>The current template of kali has two network services running. We will be using networking.service instead of NetworkManager.service. Make sure to stop and disable NetworkManager.service
>`sudo systemctl stop NetworkManager.service`
>`sudo systemctl disable NetworkManager.service`


Do the same as above. Flush the eth1 device (if it has an ip) and then put the following in `/etc/network/interfaces`: 

```
auto eth1
iface eth1 inet static
address 30.0.0.10/24
gateway 30.0.0.1
```

>[!note] 
>Change the IP address according the table below

| Hostname | IP Address |
| - | - |
| red-ops-kali-1 | 30.0.0.10 |
| red-ops-kali-2 | 30.0.0.11 |
| red-ops-kali-3 | 30.0.0.12 |
| red-ops-kali-4 | 30.0.0.13 |

Then restart the networking service and test the connection to the gateway.
```
sudo systemctl restart networking.service
ping -c 3 30.0.0.1
```



It is recommended that you fight from a cobaltstrike client on a different kali machine. This would leave red-ops-kali-2 to be responsible for handling the server and nothing else. Every operator can have their own workstation that will not effect the server if it goes down. 

[[Vulnerability and Range Setup#Network|Back to Top]]
# Implement Vulnerabilities
## Connecting  XXX-VPN-USER to domain VPN.

The initial access is to a laptop that is connected to the domain through a vpn. This vpn is hosted from the internal pfsense firewall.
Before the engagement starts, we need to test the VPN connection.
![[attachments/Vulnerability and Range Setup_image_4_20231011013008.png]]

Fortunately, this is relatively simple and can be done from the gui. 
- Console into the xxx-vpn-user box in pcte using the following credentials:

| domain | username | password | 
| - | - | - |
| pao | gerald.mcneil | n+6$nJ@F#2L6 |
| mda | cruz.harrison | j+U8H@W@L5$a |

the OpenVPN-gui application should start automatically.

![[attachments/Vulnerability and Range Setup_image_5_20231011013008.gif]]

- click up arrow in bottom right of taskbar
- right click openvpn-gui
- select `connect`
- select `ok`. 

>[!warning]- troubleshooting 
> #### Authentication
 > - if the password isn't saved, the credentials should be `remoteuser:password`
 > ![[attachments/Vulnerability and Range Setup_image_6_20231011013008.png]] 
> - If these credentials don't work, you can change them by going to the pfsense web interface. `admin:pfsense`. system -> user manager -> edit -> change password -> save. [[attachments/tmp1695509909626_Vulnerability and Range Setup_image_3.gif|Demonstration gif]]
> 
> #### DNS blocking failed
![[attachments/Vulnerability and Range Setup_image_7_20231011013008.png]]
I've seen this happen when trying to connect when the OpenVPN service wasn't running. If you haven't done anything on this box that matters, just reboot it. Otherwise, start the openvpn service as administrator ([[attachments/DNS-Block-Failed.gif|Demonstration gif]]). If that doesn't work, you may need to restart the openvpn-gui as administrator(very unusual).

Make sure to test connection to malicious domain!

```shell
ping video.memezilla.com.cn
ping google.com.ve
ping google.com.co
```

>[!warning]- Troubleshooting
>In the test range, the VPN laptop had severe intermittent connectivity problems while connected to the VPN. This was easily detected by pinging 30.0.0.11. If these exist in the actual range, then we will need to fix them in order for a staged beacon to run. Otherwise a stageless beacon may be the best course of action, but the intermittent connectivity may prove too unreliable. The payload may need to be delivered while disconnected from the VPN. 


If everything went well, close the connection until after the first beacon is on the laptop. This will not only help simulate that the attack occurred while it was detached from the domain, but it will get around the pesky network problems that seem to plague this VPN connection.

[[Vulnerability and Range Setup#Vulnerabilities|Back to Top]]


## Enable Unconstrained Delegation on MDA/PAO-SHRPT:

Lastly, we need to setup S6-0 to have Unconstrained Delegation for our plan to work.

To do this, we need to log into XXX-DC2 and open up "Active Directory Users and Computers"

>[!info]-  Domain Admin Creds
Username: administrator 
Password: Simspace3#Simspace3#

>[!tip] [[attachments/Unconstrained-Delegation.mp4| Watch Demonstration Video]]

From here, we will navigate to MDA/PAO-SHRPT and enable Unconstrained Delegation.

- mda.mil / pao.mil --> MDA/PAO --> Computers --> MDA/PAO-SHRPT
- right click -> properties
- Delegation --> "Trust this computer for delegation to any service (Kerberos only)"


![[attachments/Vulnerability and Range Setup_image_8_20231011013008.png]]


[[Vulnerability and Range Setup#Vulnerabilities|Back to Top]]

## Lateral movement via WMIC

On the Domain Controller add the S6-0 user to the `Help Desk` Domain Group

- Log into the Domain Controller
- Open up "Active Directory Users and Computers"
- Add the target S6 user to the ``Help Desk`` group.
	- PAO S6 User: ``Terry Todd``
	- MDA S6 User: ``Jeri Wu``

![[attachments/Vulnerability and Range Setup_image_9_20231011013008.png]]

## Delete malicious looking administrators.

Dominic Torreto is a DA whose password is easily crackable and is AS-REP Roastable. Delete him, we don't need him. Also delete Princess Peach. Just log in with an administrator account to change settings.

on the DC go to `Active Directory Users and Computers` -> `Users` and then find those users and `right click` -> `delete` them.


[[Vulnerability and Range Setup#Vulnerabilities|Back to Top]]


## Setting up HiveNightmare 

For us to perform privilege escalation on S6-1, we need to enable VSS and enable a restore point to store a shadow copy of the SAM. We also need to make sure that the credentials for the **s6-0 user** are stored inside of the volume shadow copy.

>[!warning] Pay attention to users!
>the S6-0 user is the administrator, and we want his credentials stored on s6-1 so that we can abuse them later. Set up the vulnerability with the S6-0 user, the target is the s6-1 box/user.

- Console into the PAO/MDA-s6-1 host in PCTE
>[!info]- Credentials
>|  name | password |
>|-- | -- |
>| XXX-s6-0\Administrator | Simspace1!Simspace1! |
>| mda\jeri.wu | `B+N5K#6YzJ#f` |
>| pao\terry.todd | `H3pEa+R2v$Q5` |

### stop user emulation
![[attachments/Vulnerability and Range Setup_image_10_20231011013008.png]]
### Enable System Protection
```
Control Panel --> System and Security --> System --> System Protection --> Configure --> "Turn on system protection" & set Disk Space Usage > 5GB
Finally hit "Create..." and name it 'initial'.
```

>[!important] [[attachments/HiveNightmareSetup.mp4|Click here for Demonstration Video]]

![[attachments/Vulnerability and Range Setup_image_11_20231011013008.png]]

The amount doesn't need to be a specific percentage --- Just make sure it is more that 5GB

Once System Protection is enabled, validate that VSS is set to autostart. If it isn't already running, we'll need to start it. Start cmd as administrator.

```
# View the service status
sc query vss
# View the service configuration
sc qc vss 
# set the service to auto start
sc config vss start= auto
# manually start the vss service if it isn't started
sc start vss
```

![[attachments/Vulnerability and Range Setup_image_12_20231011013008.png]]

To make sure that a shadow copy is made run the following in an elevated command prompt.

```
vssadmin list shadows
```

![[attachments/Vulnerability and Range Setup_image_13_20231011013008.png]]

>[!warning]- Troubleshooting
>If it is empty, then you forgot to click "Create..." in the System Protection tab. Go back and do that. It is not in the demonstration video.

[[Vulnerability and Range Setup#Vulnerabilities|Back to Top]]




--------

# Weaponization and Staging

Next we need to setup the C2 server and build and stage payloads that will be used for the emulation. Most of this can and should be done before the blue team plugs into the network. 

## Download Tools

The tools required for this emulation plan are in a zipped archive located in the **./tools** directory. Additionally, you may need to get the updated Cobalt Strike binary (`cs48.tar.gz.gpg`) from [filebrowser.pwn3d.lol](http://filebrowser.pwn3d.lol). 

Next, upload the files to PCTE by going to File Management and choosing the `24_ME_01_Tools.zip.` This will take quite some time. You can check the progress by looking at the Background Activity Monitor in the bottom left.

![[attachments/Vulnerability and Range Setup_image_14_20231011013008.png]]

In the future, we will try to put all of the tools files and obsidian notes reside inside PCTE in the kali image.

Next, create the link and copy into the firefox browser, or use wget to download it. Place it in the home folder.


![[attachments/Vulnerability and Range Setup_image_15_20231011013008.gif]]

unzip the files, and then retrieve cobalt strike from gpg. You can then delete the old cobalt strike and replace it with the new one. 
  
```bash
wget -q http://<url goes here> -O ~/24_ME_01.zip
unzip 24_ME_01.zip
cd 24_ME_01
./decrypt.sh
#password is MALware123!@#
```

Also start the sshd service so that other kali boxes can retrieve tools.
```bash
sudo systemctl start ssh.service
```

[[Vulnerability and Range Setup#Weaponization|Back to Top]]
## Start CS Teamserver

Setup the team server on red-ops-kali-2. 

```
cd ~/tools/c2/cobaltstrike
sudo ./teamserver 30.0.0.11 'MALware123!@#'
```


[[Vulnerability and Range Setup#Weaponization|Back to Top]]
## Setup CS Client

Change your PCTE console to a different kali box. I will be useing red-ops-kali-1. If you haven't already, [[Vulnerability and Range Setup#Setup CS client IPs|Setup the static ip for the CS client]].

Get the tools from the red-ops-kali-2

```bash
scp kali@30.0.0.11:/home/kali/24_ME_01.zip /home/kali/24_ME_01.zip
unzip 24_ME_01.zip
cd 24_ME_01.zip
./decrypt.sh
#password is MALware123!@#
```

Next, connect to the teamserver
 
```bash
cd cobaltstrike
./cobaltstrike 30.0.0.11
```

You can change the `alias` and `user` fields to anything. but the `host` field should contain the ip address of the teamserver. The default port 50050 should work fine. Make sure to put in the password `MALware123!@#`
![[attachments/Vulnerability and Range Setup_image_16_20231011013008.png]]

Accept the fingerprint.

You should now have cobalt strike up and running on your system.

>[!tip]- (Optional)Setup Dark Mode
Go to `Cobalt Strike -> Preferences` then change GUI Theme to Dark. You will then need to close and restart the client.
>![[attachments/Vulnerability and Range Setup_image_17_20231011013008.png]]
>>[!tip]- [[attachments/darkmode.gif|Click for Demonstration gif]].

>[!hint]- (Optional) Setup rename cna script
>[Dynamictabrename](https://github.com/EspressoCake/DynamicTabRename/tree/master)
>To help keep track of beacons we are going to load a cna script to help us rename our beacons. You can use `ctrl+r` to rename the tabs in default CS, but if you close the tab, the name will go way. This script will help it persit. 
>```bash
>scp kali@30.0.0.11:/home/kali/scenario2/dynamictab.zip /tmp
>unzip /tmp/dynamictab.zip -d ~/tools/c2/cobaltstrike
>```
>Next, in CS go to `Cobalt Strike` --> `Script Manager`
>This will open the Scripts tab
>click `Load` and then select ~/tools/c2/cobaltstrike/DynamicTabRename-master/tabRename.cna
>Now you can rename tabs one time with `cbm <name>` 

>[!info]- Organize i3
>If you are using i3, it's a good time to organize your
>workspaces. I recommend sending cobaltstrike to 
>workspace 2 with alt+shift+2 and the cobaltstrike 
>terminal to workspace 10 with alt+shift+0. You can 
>then focus the cobaltstrike client with alt+2.

[[Vulnerability and Range Setup#Weaponization|Back to Top]]
##  Start Listeners
First setup you cobalt strike http listener. This will be used by cobalt strike to communicate with beacons. 

- Go to `Cobalt Strike`-> `Listeners` or click the ![[attachments/Vulnerability and Range Setup_image_18_20231011013008.png]] icon.

This will open up the listeners tab. 

- On this tab, click `Add`.

- Fill out the box with the following info:  
![[attachments/Vulnerability and Range Setup_image_19_20231011013008.png]]

>[!info]- Understanding the Fields
>Let's Talk about what we just did
>- HTTP Hosts: these are hosts for the HTTP(S) Beacon to call home to.
>- Host Rotation Strategy: Round-Robin loops through the list of host names in the order 
>- they are provided. Each host is used for one connection
>- HTTP Host (Stager): This Controls the host of the HTTP Stager for the HTTP Beacon. 
>- This value is ONLY used if you pair this payload with an attack that REQUIRES an explicit stager.
>- HTTP Port (C2): This field sets the port your HTTP(S) Beacon will phone home to.

![[attachments/Vulnerability and Range Setup_image_20_20231011013008.png]]


[[Vulnerability and Range Setup#Weaponization|Back to Top]]

## Create and Stage Payloads

Next create and Stage the payloads:


### Scripted web delivery

#### URI for initial Access (google.com.ve/search&q=nightmares)


Go to `Attacks` --> `Scripted Web Delivery(S)` and fill in the following.

![[attachments/Vulnerability and Range Setup_image_21_20231011013008.png]]




>[!info]- Understand the Fields
>Let's Talk about what we just did
>- Local Host: This will be the webserver that will be hosted for our beacon to download on 
>- the victim. This is created by CobaltStrike.
>- Local Port: The port that our webserver will be on.
>- Listener: This is our listener that we created earlier.

#### Make a 32 bit uri for the word macro. (www.google.com.ve/search&q=nightmare)

![[attachments/Vulnerability and Range Setup_image_22_20231011013008.png]]

>[!warning] Make sure to uncheck the x64 box!


### URI for wmic

the ampersand breaks the wmic command and I haven't figured out how to make it work correctly. So I used this uri with no ampersand.

![[attachments/Vulnerability and Range Setup_image_23_20231011013008.png]]



### Word Macro (optional)

The word document included in the plan reaches back to the CS server using the powershell one liner to www.google.com.ve/search&q=nightmares. If you want to use a different one, you'll either have to edit it yourself to change the endpoint or you can make a cobalt strike macro using the following.

- Go to `Payloads` --> `MS Office Macro`
- Then select the HTTP Listener and click `Generate`.
- Click `Copy Macro` to copy macro to clipboard. 
- Paste the macro into  ~/scenario2/macro.txt

You will need to open the document on a windows computer and change the value of the macro that is already in there with the contents of macro.txt. 

>[!important] Save the macro in the document!
>The most important step of creating the macro is that you save the macro in the document. Otherwise, the macro won't exist once you get it onto target. 
>Once you've opened the `Macros` dialog box, give the macro a name and then select the document from the `Macros in:` dialog box.
>![[attachments/Vulnerability and Range Setup_image_24_20231011013008.png]]


[[Vulnerability and Range Setup#Weaponization|Back to Top]]